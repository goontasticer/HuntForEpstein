<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Initialization Test</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #fff;
            padding: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass {
            background: #2a5a2a;
            border: 1px solid #4CAF50;
        }
        .fail {
            background: #5a2a2a;
            border: 1px solid #f44336;
        }
        .warn {
            background: #5a5a2a;
            border: 1px solid #ff9800;
        }
        pre {
            background: #1a1a1a;
            padding: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Game Initialization Test</h1>
    <div id="results"></div>
    
    <!-- Scripts MUST be loaded in dependency order -->
    <!-- Level 0: Third-party libraries -->
    <script src="/lib/MakkoEngine.min.js"></script>

    <!-- Level 1: Utilities (no dependencies) -->
    <script src="src/utils/constants.js"></script>
    <script src="src/utils/math.js"></script>

    <!-- Level 2: Core systems (depend on utils) -->
    <script src="src/core/input.js"></script>
    <script src="src/core/loop.js"></script>

    <!-- Level 3: Engine (depends on utils + core) -->
    <script src="src/engine/renderer.js"></script>
    <script src="src/engine/physics.js"></script>

    <!-- Level 4: Game entities (depend on engine) -->
    <script src="src/game/player.js"></script>
    <script src="src/game/level.js"></script>
    <script src="src/game/entities.js"></script>
    <script src="src/game/stealth-system.js"></script>
    <script src="src/game/trapdoor.js"></script>
    <script src="src/game/camera.js"></script>
    <script src="src/game/world.js"></script>

    <!-- Level 5: UI Systems (depend on game entities) -->
    <script src="src/ui/gamestate.js"></script>
    <script src="src/ui/ui-system.js"></script>
    <script src="src/ui/hud.js"></script>
    <script src="src/ui/menus.js"></script>
    <script src="src/ui/permadeath.js"></script>

    <!-- Level 6: Game loop and initialization (depends on all) -->
    <script src="src/game/main.js"></script>

    <script>
        function addResult(test, status, message, details = null) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${status}`;
            div.innerHTML = `
                <strong>${test}:</strong> ${message}
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            results.appendChild(div);
        }

        function checkDependencies() {
            console.log('Checking core dependencies...');
            
            // Level 1: Utilities
            if (typeof window.GAME_CONSTANTS === 'undefined') {
                addResult('GAME_CONSTANTS', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('GAME_CONSTANTS', 'pass', 'Loaded successfully');
            }

            if (typeof window.MathUtils === 'undefined') {
                addResult('MathUtils', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('MathUtils', 'pass', 'Loaded successfully');
            }

            // Level 2: Core systems
            if (typeof window.Input === 'undefined') {
                addResult('Input System', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Input System', 'pass', 'Loaded and initialized');
            }

            if (typeof window.GameLoop === 'undefined') {
                addResult('Game Loop', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Game Loop', 'pass', 'Loaded and initialized');
            }

            // Level 3: Engine
            if (typeof window.Renderer === 'undefined') {
                addResult('Renderer', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Renderer', 'pass', 'Loaded successfully');
            }

            if (typeof window.PhysicsEngine === 'undefined') {
                addResult('Physics Engine', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Physics Engine', 'pass', 'Loaded successfully');
            }

            if (typeof window.Vector2D === 'undefined') {
                addResult('Vector2D', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Vector2D', 'pass', 'Loaded successfully');
            }

            // Level 4: Game State
            if (typeof window.GameStateManager === 'undefined') {
                addResult('Game State Manager', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Game State Manager', 'pass', 'Loaded successfully');
            }

            // Level 5: UI Systems
            if (typeof window.UISystem === 'undefined') {
                addResult('UI System', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('UI System', 'pass', 'Loaded successfully');
            }

            // Level 6: Main Game
            if (typeof window.EpsteinGame === 'undefined') {
                addResult('Main Game', 'fail', 'Not loaded');
                return false;
            } else {
                addResult('Main Game', 'pass', 'Loaded successfully');
            }

            return true;
        }

        function testMathUtils() {
            console.log('Testing MathUtils...');
            
            try {
                // Test basic math functions
                const clampResult = window.MathUtils.clamp(1.5, 0, 1);
                if (clampResult !== 1) {
                    addResult('MathUtils.clamp', 'fail', `Expected 1, got ${clampResult}`);
                    return false;
                }

                // Test Vector2D
                const vec1 = new window.Vector2D(1, 2);
                const vec2 = new window.Vector2D(3, 4);
                const sum = vec1.add(vec2);
                if (sum.x !== 4 || sum.y !== 6) {
                    addResult('Vector2D.add', 'fail', `Expected (4, 6), got (${sum.x}, ${sum.y})`);
                    return false;
                }

                addResult('MathUtils/Vector2D', 'pass', 'All math utilities working correctly');
                return true;
            } catch (error) {
                addResult('MathUtils/Vector2D', 'fail', `Error: ${error.message}`);
                return false;
            }
        }

        function testInputSystem() {
            console.log('Testing Input System...');
            
            try {
                // Test input mapping
                if (window.Input.isActionDown('moveUp')) {
                    addResult('Input System', 'warn', 'moveUp action already pressed');
                }

                // Test action mapping
                const keys = window.Input.getActionKeys('moveUp');
                if (!keys.includes('ArrowUp') || !keys.includes('KeyW')) {
                    addResult('Input Mapping', 'fail', 'moveUp not properly mapped to ArrowUp and W');
                    return false;
                }

                addResult('Input System', 'pass', 'Input system working correctly');
                return true;
            } catch (error) {
                addResult('Input System', 'fail', `Error: ${error.message}`);
                return false;
            }
        }

        function testRenderer() {
            console.log('Testing Renderer...');
            
            try {
                // Create test canvas
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 600;
                
                // Create renderer
                const renderer = new window.Renderer(canvas);
                
                if (!renderer.ctx) {
                    addResult('Renderer', 'fail', 'Failed to get canvas context');
                    return false;
                }

                // Test camera functions
                renderer.setCameraPosition(100, 100);
                if (renderer.camera.targetX !== -300 || renderer.camera.targetY !== -200) {
                    addResult('Renderer Camera', 'fail', 'Camera position not set correctly');
                    return false;
                }

                addResult('Renderer', 'pass', 'Renderer working correctly');
                return true;
            } catch (error) {
                addResult('Renderer', 'fail', `Error: ${error.message}`);
                return false;
            }
        }

        function testPhysics() {
            console.log('Testing Physics Engine...');
            
            try {
                // Create physics engine
                const physics = new window.PhysicsEngine();
                
                // Test AABB collision
                const box1 = new window.AABB(0, 0, 10, 10);
                const box2 = new window.AABB(5, 5, 10, 10);
                const box3 = new window.AABB(20, 20, 10, 10);
                
                if (!box1.intersects(box2)) {
                    addResult('Physics AABB', 'fail', 'Box1 should intersect Box2');
                    return false;
                }
                
                if (box1.intersects(box3)) {
                    addResult('Physics AABB', 'fail', 'Box1 should not intersect Box3');
                    return false;
                }

                // Test Circle collision
                const circle1 = new window.Circle(0, 0, 5);
                const circle2 = new window.Circle(3, 4, 5);
                const circle3 = new window.Circle(20, 20, 5);
                
                if (!circle1.intersects(circle2)) {
                    addResult('Physics Circle', 'fail', 'Circle1 should intersect Circle2');
                    return false;
                }
                
                if (circle1.intersects(circle3)) {
                    addResult('Physics Circle', 'fail', 'Circle1 should not intersect Circle3');
                    return false;
                }

                addResult('Physics Engine', 'pass', 'Physics system working correctly');
                return true;
            } catch (error) {
                addResult('Physics Engine', 'fail', `Error: ${error.message}`);
                return false;
            }
        }

        function testGameState() {
            console.log('Testing Game State Manager...');
            
            try {
                // Create game state manager
                const gameState = new window.GameStateManager();
                
                if (gameState.getState() !== window.GAME_CONSTANTS.GAME_STATES.MENU) {
                    addResult('Game State', 'fail', 'Initial state should be MENU');
                    return false;
                }

                // Test state transition
                const success = gameState.setState(window.GAME_CONSTANTS.GAME_STATES.PLAYING);
                if (!success) {
                    addResult('Game State Transition', 'fail', 'Failed to transition to PLAYING state');
                    return false;
                }

                if (!gameState.isInGame()) {
                    addResult('Game State', 'fail', 'Should be in PLAYING state');
                    return false;
                }

                addResult('Game State Manager', 'pass', 'Game state system working correctly');
                return true;
            } catch (error) {
                addResult('Game State Manager', 'fail', `Error: ${error.message}`);
                return false;
            }
        }

        async function testGameInitialization() {
            console.log('Testing Game Initialization...');
            
            try {
                // Create test canvas
                const canvas = document.createElement('canvas');
                canvas.width = 1920;
                canvas.height = 1080;
                document.body.appendChild(canvas);
                
                // Create game instance
                const game = new window.EpsteinGame();
                
                // Test initialization
                await game.initialize(canvas);
                
                if (!game.isInitialized) {
                    addResult('Game Initialization', 'fail', 'Game failed to initialize');
                    return false;
                }

                // Test that all systems are available
                const stats = game.getStats();
                if (!stats.initialized) {
                    addResult('Game Stats', 'fail', 'Game stats show not initialized');
                    return false;
                }

                addResult('Game Initialization', 'pass', 'Game initialized successfully');
                addResult('Game Stats', 'pass', `Level: ${stats.currentLevel}, Assets loaded: ${stats.assetsLoaded}`);
                return true;
            } catch (error) {
                addResult('Game Initialization', 'fail', `Error: ${error.message}`, error.stack);
                return false;
            }
        }

        async function runAllTests() {
            console.log('Starting initialization tests...');
            addResult('Test Suite', 'pass', 'Starting dependency and initialization tests');
            
            let allPassed = true;
            
            // Check basic dependencies
            if (!checkDependencies()) {
                addResult('Test Suite', 'fail', 'Core dependencies failed - stopping tests');
                return;
            }
            
            // Test individual systems
            allPassed &= testMathUtils();
            allPassed &= testInputSystem();
            allPassed &= testRenderer();
            allPassed &= testPhysics();
            allPassed &= testGameState();
            
            // Test full game initialization
            allPassed &= await testGameInitialization();
            
            // Final result
            if (allPassed) {
                addResult('Test Suite', 'pass', 'All tests passed! Game can initialize without dependency errors.');
            } else {
                addResult('Test Suite', 'fail', 'Some tests failed. Check the errors above.');
            }
        }

        // Run tests when page loads
        window.addEventListener('load', () => {
            // Give scripts time to initialize
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>